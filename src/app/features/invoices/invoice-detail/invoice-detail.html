<div class="space-y-4">
  @if (loading()) {
    <div class="flex justify-center py-12">
      <div class="h-8 w-8 animate-spin rounded-full border-2 border-primary border-t-transparent" aria-hidden="true"></div>
    </div>
  } @else {
    @let inv = invoice();
    @if (inv) {
      <header class="flex flex-wrap items-center justify-between gap-4 border-b border-gray-200 pb-4">
        <div class="min-w-0">
          <h1 class="text-xl font-semibold text-gray-900">Invoice {{ inv.number }}</h1>
          <span
            class="mt-1 inline-block rounded-full px-2.5 py-0.5 text-xs font-medium"
            [class]="getStatusBadgeClass(inv.status)"
          >
            {{ inv.status }}
          </span>
        </div>
        @if (!editing()) {
          <div class="flex flex-wrap items-center gap-2">
            <button
              type="button"
              (click)="startEdit()"
              [disabled]="actionLoading()"
              class="rounded bg-primary px-4 py-2 text-sm font-medium text-primary-foreground hover:bg-primary-hover disabled:opacity-50"
            >
              Edit
            </button>
            <button
              type="button"
              (click)="deleteInvoice()"
              [disabled]="actionLoading()"
              class="rounded bg-red-600 px-4 py-2 text-sm font-medium text-white hover:bg-red-700 disabled:opacity-50"
            >
              Delete
            </button>
          </div>
        }
      </header>

      @if (editing()) {
        <div class="rounded-lg border border-gray-200 bg-white p-4">
          <h2 class="text-sm font-semibold text-gray-900 mb-3">Edit invoice</h2>
          <div class="space-y-3 max-w-md">
            <div>
              <label for="edit-status" class="block text-sm font-medium text-gray-700">Status</label>
              <select
                id="edit-status"
                [(ngModel)]="editStatus"
                name="editStatus"
                class="mt-1 w-full rounded border border-gray-300 px-3 py-2 text-gray-900 focus:border-primary focus:outline-none focus:ring-1 focus:ring-primary"
              >
                @for (opt of statusOptions; track opt.value) {
                  <option [value]="opt.value">{{ opt.label }}</option>
                }
              </select>
            </div>
            <div>
              <label for="edit-dueDate" class="block text-sm font-medium text-gray-700">Due date</label>
              <input
                id="edit-dueDate"
                type="date"
                [(ngModel)]="editDueDate"
                name="editDueDate"
                class="mt-1 w-full rounded border border-gray-300 px-3 py-2 text-gray-900 focus:border-primary focus:outline-none focus:ring-1 focus:ring-primary"
              />
            </div>
            <div>
              <label for="edit-pdfUrl" class="block text-sm font-medium text-gray-700">PDF URL</label>
              <input
                id="edit-pdfUrl"
                type="url"
                [(ngModel)]="editPdfUrl"
                name="editPdfUrl"
                class="mt-1 w-full rounded border border-gray-300 px-3 py-2 text-gray-900 focus:border-primary focus:outline-none focus:ring-1 focus:ring-primary"
                placeholder="https://..."
              />
            </div>
            <div class="flex gap-2 pt-2">
              <button
                type="button"
                (click)="saveEdit()"
                [disabled]="actionLoading()"
                class="rounded bg-primary px-4 py-2 text-sm font-medium text-primary-foreground hover:bg-primary-hover disabled:opacity-50"
              >
                {{ actionLoading() ? 'Saving…' : 'Save' }}
              </button>
              <button
                type="button"
                (click)="cancelEdit()"
                [disabled]="actionLoading()"
                class="rounded border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50"
              >
                Cancel
              </button>
            </div>
          </div>
        </div>
      } @else {
        <div class="rounded-lg border border-gray-200 bg-white p-4">
          <h2 class="text-sm font-semibold text-gray-900">Details</h2>
          <dl class="mt-3 space-y-2 text-sm">
            <div>
              <dt class="text-gray-500">Number</dt>
              <dd class="text-gray-900">{{ inv.number }}</dd>
            </div>
            <div>
              <dt class="text-gray-500">Amount</dt>
              <dd class="font-medium text-gray-900">{{ inv.amount }} {{ inv.currency }}</dd>
            </div>
            <div>
              <dt class="text-gray-500">Issue date</dt>
              <dd class="text-gray-900">{{ formatDate(inv.issueDate) }}</dd>
            </div>
            <div>
              <dt class="text-gray-500">Due date</dt>
              <dd class="text-gray-900">{{ formatDateOnly(inv.dueDate) }}</dd>
            </div>
            <div>
              <dt class="text-gray-500">Booking ID</dt>
              <dd class="font-mono text-xs text-gray-600">{{ inv.bookingId }}</dd>
            </div>
            @if (inv.pdfUrl) {
              <div>
                <dt class="text-gray-500">PDF</dt>
                <dd>
                  <a
                    [href]="inv.pdfUrl"
                    target="_blank"
                    rel="noopener noreferrer"
                    class="text-primary hover:underline"
                  >
                    Open PDF
                  </a>
                </dd>
              </div>
            }
            <div>
              <dt class="text-gray-500">Created</dt>
              <dd class="text-gray-900">{{ formatDate(inv.createdAt) }}</dd>
            </div>
          </dl>
        </div>
      }

      <div class="flex gap-3">
        <a
          routerLink="/app/invoices"
          class="rounded border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50"
        >
          ← Back to invoices
        </a>
      </div>
    } @else {
      <p class="text-gray-500">Invoice not found.</p>
    }
  }
</div>

<app-confirmation-dialog
  [open]="confirmOpen()"
  [title]="confirmPayload()?.title ?? 'Confirm'"
  [message]="confirmPayload()?.message ?? ''"
  [confirmLabel]="confirmPayload()?.confirmLabel ?? 'Confirm'"
  [danger]="confirmPayload()?.danger ?? false"
  cancelLabel="Cancel"
  (confirm)="onConfirmDialogConfirm()"
  (cancel)="onConfirmDialogCancel()"
/>
